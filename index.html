<!DOCTYPE html>
<html lang="ja">
<head>
<title>アナログ時間制限タイマー</title>
<style>
body{
  margin:0;
  background:#000;
  overflow:hidden;
  font-family:Arial, sans-serif;
  color:white;
}

#main{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100vh;
}

canvas{
  display:block;
}

#remaining{
  font-size:3vw;
  margin-top:2vh;
}

#settings{
  position:fixed;
  bottom:20px;
  width:100%;
  text-align:center;
}

#backBtn{
  position:fixed;
  right:20px;
  top:20px;
  font-size:18px;
  padding:5px 15px;
  display:none;
}

input{
  font-size:20px;
  width:60px;
}

button{
  font-size:20px;
  padding:5px 15px;
  margin:5px;
}
</style>
</head>
<body>

<button id="backBtn" onclick="exitFull()">戻る</button>

<div id="main">
  <canvas id="clockCanvas"></canvas>
  <div id="remaining"></div>
</div>

<div id="settings">
  NG開始分:
  <input type="number" id="startMin" min="0" max="59" value="0">
  NG終了分:
  <input type="number" id="endMin" min="0" max="59" value="10">
  <br>
  <button onclick="startTimer()">開始</button>
  <button onclick="enterFull()">フルスクリーン</button>
</div>

<audio id="alertSound" src="1.mp3"></audio>

<script>
let startMinute = 0;
let endMinute = 10;
let lastState = "";

const canvas = document.getElementById("clockCanvas");
const ctx = canvas.getContext("2d");
let radius;

function resizeClock(){
  const size = Math.min(window.innerWidth, window.innerHeight) * 0.8;
  canvas.width = size;
  canvas.height = size;
  radius = size / 2;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.translate(radius, radius);
}
window.addEventListener("resize", resizeClock);
resizeClock();

function startTimer(){
  startMinute = parseInt(document.getElementById("startMin").value);
  endMinute = parseInt(document.getElementById("endMin").value);
}

function enterFull(){
  document.documentElement.requestFullscreen();
  document.getElementById("settings").style.display="none";
  document.getElementById("backBtn").style.display="block";
}

function exitFull(){
  document.exitFullscreen();
  document.getElementById("settings").style.display="block";
  document.getElementById("backBtn").style.display="none";
}

function drawClock(){
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();
  const s = now.getSeconds();

  let state;
  let targetMinute;

  if(startMinute <= endMinute){
    if(m >= startMinute && m < endMinute){
      state="NG"; targetMinute=endMinute;
    }else{
      state="OK"; targetMinute=startMinute;
      if(m>=endMinute) targetMinute+=60;
    }
  }else{
    if(m>=startMinute || m<endMinute){
      state="NG"; targetMinute=endMinute;
      if(m>=startMinute) targetMinute+=60;
    }else{
      state="OK"; targetMinute=startMinute;
    }
  }

  if(state!==lastState){
    document.getElementById("alertSound").play();
    lastState=state;
  }

  ctx.clearRect(-radius,-radius,canvas.width,canvas.height);

  const color = (state==="NG") ? "red" : "lime";

  // 外枠
  ctx.beginPath();
  ctx.arc(0,0,radius-10,0,2*Math.PI);
  ctx.lineWidth=15;
  ctx.strokeStyle=color;
  ctx.stroke();

  // 目盛りと数字
  ctx.font = radius*0.15 + "px Arial";
  ctx.textBaseline="middle";
  ctx.textAlign="center";
  ctx.fillStyle=color;

  for(let num=1; num<=12; num++){
    let ang = num * Math.PI / 6;
    ctx.rotate(ang);
    ctx.translate(0, -radius*0.8);
    ctx.rotate(-ang);
    ctx.fillText(num.toString(),0,0);
    ctx.rotate(ang);
    ctx.translate(0, radius*0.8);
    ctx.rotate(-ang);
  }

  // 針
  drawHand((h%12)*Math.PI/6 + m*Math.PI/(6*60), radius*0.5, 6,"white");
  drawHand(m*Math.PI/30, radius*0.7, 4,"white");
  drawHand(s*Math.PI/30, radius*0.8, 2,"red");

  // 残り時間
  let currentSec = m*60+s;
  let targetSec = (targetMinute%60)*60;
  if(targetMinute>=60) targetSec=((targetMinute-60)*60);
  let diff=targetSec-currentSec;
  if(diff<0) diff+=3600;

  let remMin=Math.floor(diff/60).toString().padStart(2,'0');
  let remSec=(diff%60).toString().padStart(2,'0');
  document.getElementById("remaining").textContent=
    "次の切替まで "+remMin+":"+remSec;
}

function drawHand(pos,length,width,color){
  ctx.beginPath();
  ctx.lineWidth=width;
  ctx.lineCap="round";
  ctx.strokeStyle=color;
  ctx.moveTo(0,0);
  ctx.rotate(pos);
  ctx.lineTo(0,-length);
  ctx.stroke();
  ctx.rotate(-pos);
}

setInterval(drawClock,1000);
drawClock();
</script>

</body>
</html>
